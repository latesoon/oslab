# lab2 操作系统实验报告

### 姚知言 2211290 贾景顺 2211312 李政远 2211320


### Exercise1：理解first-fit 连续物理内存分配算法
## Exercise1：理解first-fit 连续物理内存分配算法
>first-fit 连续物理内存分配算法作为物理内存分配一个很基础的方法，需要同学们理解它的实现过程。请大家仔细阅读实验手册的教程并结合kern/mm/default_pmm.c中的相关代码，认真分析default_init，default_init_memmap，default_alloc_pages， default_free_pages等相关函数，并描述程序在进行物理内存分配的过程以及各个函数的作用。 请在实验报告中简要说明你的设计实现过程。请回答如下问题：  
你的first fit算法是否有进一步的改进空间？    

#### 虚拟内存的构建

当操作系统完成加电以及进入内核后，通过修改内核代码的链接地址并构建合适的页表项（减去虚拟地址和物理地址间的偏移量`0xffffffff40000000`），随后令页基址寄存器指向页表基质并刷新TLB（因为改变`satp`的同时也改变了映射方式），这样就成功构建了虚拟内存及其分页机制。
#### 内存分配初始化
进一步地，需要探究在这样的机制下是如何进行物理内存的管理与分配的。首先在`kern_init`中通过对于`pmm_init`的调用，在其内部调用了`init_pmm_manager`实现了对`pmm_manager`结构体的初始化，即选择管理页面算法并初始化对应的参数；随后在`page_init`中，实现可用页面起始地址与数量的计算与分配，并在`init_memmap`进行更加详细的初始化。
在经过上述一系列流程，程序成功完成了对物理内存分配模式的选择及初始化，当程序需要内核占据以外的物理地址时，能够按照所选择的结构体进行正确分配或引发异常。
#### First-Fit内存分配算法
在物理内存管理中，first-fit算法是一种简单且有效的内存分配策略。它通过遍历空闲内存块，找到第一个满足请求大小的块并进行分配。下面将分别阐述`default_init`、`default_init_memmap`、`default_alloc_pages` 和 `default_free_pages’`函数的作用。
-default_init
调用 `list_init(&free_list) `初始化空闲页面链表，并将可用页面计数 `nr_free `设为0。确保系统开始时没有可用的物理页面，实现了内存管理方法的初始化。
- default_init_memmap
该函数用于初始化一段连续的物理页块，并将其插入到空闲链表中。
具体实现了遍历给定的页面范围，检查每个页面是否被保留，清除其标志和属性，并将引用计数设置为0；设置基础页面的属性（property）为传入的页面数量，并将其标记为已分配；更新可用页面计数并根据页面的地址插入到空闲页面链表中，保持有序性。
- default_alloc_pages
在给定需求下找到空闲链表中第一个符合要求的空闲页块，具体实现流程如下：
首先进行需求是否大于0以及是否大于当前所有空闲页数量的判定，若数据在范围之内，将遍历空闲链表直到搜索到第一个空闲页面数大于等于需求的页块，并将需要的页面数分配出去。随后对链表进行更新，具体表现为断开当前页块与前节点的连接，更新其空闲页块数’property’，并将更新后的节点重新连接。
- default_free_pages
在指定的页面处释放给定数量的空间，先以基址为起点遍历将页表的`flag`位置0表示未分配，并更改基址的`property`的值以及可分配页面数；随后利用双向链表的前后节点合并相邻的空闲页面，以减少内存碎片。
#### First-Fit内存分配算法的改进
1.	first fit算法会产生大量小的碎片内存块,浪费空间。可以设定一个固定周期合并可以合并的内存碎片，例如进行100次内存分配就遍历进行合并一次，将其合并到相邻的空闲内存块中，减少碎片；或采取懒惰合并，仅在需要分配空间的时候进行合并。
2.	使用多个空闲块链表来管理不同大小范围的空闲块。根据空闲块的大小将它们分别放入对应的链表中，在分配时可优先从大小适配的链表中查找空闲块，减少在整个空闲块链表中搜索的时间。

### Exercise2：实现 best-fit 连续物理内存分配算法

#### 编程实现

#### 测试结果

通过make grade获取成绩。成功通过了所有check要求，得分30/30。

![](score.png)

#### 改进空间

### Challenge1：buddy system（伙伴系统）分配算法

该部分的设计文档单独建立了markdown文件，请参阅$lab2\_buddy.md$。

### Challenge2：任意大小的内存单元slub分配算法

### Challenge3：硬件的可用物理内存范围的获取方法

#### 如果 OS 无法提前知道当前硬件的可用物理内存范围，请问你有何办法让 OS 获取可用物理内存范围？
1.  BIOS/UEFI 查询.在开机自检（POST）阶段，BIOS 或 UEFI 固件会识别系统中的硬件组件，包括内存。操作系统在启动时，会通过特定的接口调用这些固件提供的服务，获取内存信息。在现代系统中，ACPI（高级配置和电源接口）是一个关键的组成部分，它不仅提供了硬件的配置信息，还可以报告可用内存的具体范围。操作系统会解析 ACPI 表，获取有关内存的地址范围、大小以及保留内存和可用内存的具体信息。这一过程通常是自动进行的，确保操作系统能够正确地了解可用的物理内存区域，以便进行有效的内存管理。
2.  内存探测算法。当操作系统试图访问某个未被映射或不存在的内存地址时，硬件会触发异常（如页错误）。通过这种方式，操作系统可以“探测”到哪些地址是可访问的，从而推断出有效的内存范围。在系统配置不确定的情况下。它提供了一种有效的方式来发现实际的可用内存.

